name: Video_Stream_Fix_To_Firebase
on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Direct Link (Seedr)'
        required: true

jobs:
  convert_and_upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ—ï¸ Setup Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 ffmpeg python3-pip
          pip3 install firebase-admin

      - name: â¬‡ï¸ Download Video
        run: |
          aria2c --max-connection-per-server=16 --split=16 -o "source_video" "${{ github.event.inputs.video_url }}"

      - name: ğŸ¬ Fast Process (Stream Copy)
        run: |
          ffmpeg -i "source_video" -c copy -movflags +faststart -y "final_video.mp4"

      - name: ğŸš€ Upload to GitHub Release
        id: upload_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ github.run_number }}"
          files: final_video.mp4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Push Data to Firebase
        shell: python
        env:
          # Ù„ÛØ±Û• Ú©Ù„ÛŒÙ„Û•Ú©Û•Øª Ø¨Û† Ø¯Ø§Ø¯Û•Ù†ÛÙ… Ø¨Û• Ø´ÛÙˆÛ•ÛŒ Ú©Ø§ØªÛŒ Ø¨Û† Ø¦Û•Ù… Ú©Ø§Ø±Û•
          FB_KEY: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          DATABASE_URL: "https://sarko-43d61-default-rtdb.firebaseio.com/"
        run: |
          import firebase_admin
          from firebase_admin import credentials, db
          import json
          import os

          try:
              # ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ú©Ù„ÛŒÙ„Û•Ú©Û• Ù„Û• Ø³Ú©Ø±ÛØªØ³
              key_dict = json.loads(os.environ['FB_KEY'])
              cred = credentials.Certificate(key_dict)
              firebase_admin.initialize_app(cred, {'databaseURL': os.environ['DATABASE_URL']})
              
              ids_to_update = ["20029", "20030", "20031", "20032", "20033", "20034"]
              github_repo = os.environ['GITHUB_REPOSITORY']
              run_number = os.environ['GITHUB_RUN_NUMBER']
              
              video_data = {
                  "badge_text": "FREE",
                  "description": "Ú†ÛŒØ±Û†Ú©ÛŒ ÙÛŒÙ„Ù…Û•Ú©Û• Ø¨Ø§Ø³ Ù„Û• Ú©Ú†ÛÚ©ÛŒ Ú¯Û•Ù†Ø¬ Ø¯Û•Ú©Ø§Øª Ú©Û• Ù„Û• Ú•ÛÚ¯Û•ÛŒ Ø¦Û•Ù¾ÛÚ©ÛŒ Ú˜ÙˆØ§Ù†Ø¨Û•Ø³ØªÙ†Û•ÙˆÛ• Ú©ÙˆÚ•ÛÚ© Ø¯Û•Ù†Ø§Ø³ÛØª Ú©Û• Ø²Û†Ø± Ø³Û•Ø±Ù†Ø¬Ú•Ø§Ú©ÛØ´ Ùˆ Ø¨Û•Ú•Û•ÙˆØ´Øª Ø¯Û•Ø±Ø¯Û•Ú©Û•ÙˆÛØª. Ù‡Û•Ù…ÙˆÙˆ Ø´ØªÛÚ© Ø¨Û• Ø¬ÙˆØ§Ù†ÛŒ Ø¯Û•Ø³Øª Ù¾Û Ø¯Û•Ú©Ø§ØªØŒ Ø¨Û•ÚµØ§Ù… Ú©Ø§ØªÛÚ© Ú©Ú†Û•Ú©Û• Ø¯Û•Ú†ÛØªÛ• Ù†Ø§Ùˆ Ú˜ÛŒØ§Ù†ÛŒ ØªØ§ÛŒØ¨Û•ØªÛŒ Ú©ÙˆÚ•Û•Ú©Û•ÙˆÛ•ØŒ ÙˆØ±Ø¯Û• ÙˆØ±Ø¯Û• Ù‡Û•Ø³Øª Ø¨Û• Ø´ØªÛŒ Ø³Û•ÛŒØ± Ùˆ Ù†Ø§Ø¦Ø§Ø³Ø§ÛŒÛŒ Ø¯Û•Ú©Ø§Øª. Ø¦Û•Ùˆ ØªÛØ¯Û•Ú¯Ø§Øª Ú©Û• Ø¦Û•Ù… 'Ú©ÙˆÚ•Û• Ø¨Ø§Ø´Û•' Ù†Ù‡ÛÙ†ÛŒÛŒÛ•Ú©ÛŒ ØªØ±Ø³Ù†Ø§Ú©ÛŒ Ù‡Û•ÛŒÛ• Ú©Û• Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ø¨Û• Ú•Ø§Ø¨Ø±Ø¯ÙˆÙˆÛŒÛ•ÙˆÛ• Ù‡Û•ÛŒÛ•. ÙÛŒÙ„Ù…Û•Ú©Û• Ù…Ù„Ù…Ù„Ø§Ù†ÛÛŒÛ•Ú©ÛŒ Ø¯Û•Ø±ÙˆÙˆÙ†ÛŒ ØªÙˆÙ†Ø¯Û• Ùˆ Ø¨ÛŒÙ†Û•Ø± Ù„Û• Ù†Ø§Ùˆ Ú¯ÙˆÙ…Ø§Ù† Ùˆ ØªØ±Ø³Ø¯Ø§ Ø¯Û•Ù‡ÛÚµÛØªÛ•ÙˆÛ•ØŒ ØªØ§ Ø¦Û•Ùˆ Ø³Ø§ØªÛ•ÛŒ Ú•Ø§Ø³ØªÛŒÛŒÛ•Ú©Ø§Ù† Ø¨Û• Ø´ÛÙˆÛ•ÛŒÛ•Ú©ÛŒ Ø´Û†Ú©Ú©Û•Ø± Ø¦Ø§Ø´Ú©Ø±Ø§ Ø¯Û•Ø¨Ù†.",
                  "genre_id": 6,
                  "image": "https://raw.githubusercontent.com/Skugiijb546vi/ok/refs/heads/main/good-boy-2025.jpg",
                  "imdb": 8.5,
                  "subtitleArabic": "https://raw.githubusercontent.com/Skugiijb546vi/Boolo_ass/refs/heads/main/Good.Boy.2025.1080p.AMZN.WEB-DL.DDP5.1.H.264-English.srt",
                  "subtitleEnglish": "https://raw.githubusercontent.com/Skugiijb546vi/Boolo_ass/refs/heads/main/Good.Boy.2025.1080p.AMZN.WEB-DL.DDP5.1.H.264-English.srt",
                  "subtitleKurdish": "https://raw.githubusercontent.com/Skugiijb546vi/kurdil/refs/heads/main/oi.srt",
                  "title": "good boy _ Ú©ÙˆÚ•Û• Ø¨Ø§Ø´Û•Ú©Û•",
                  "translation": "Ú˜ÛØ±Ù†ÙˆÙˆØ³",
                  "url": f"https://github.com/{github_repo}/releases/download/v{run_number}/final_video.mp4",
                  "views": 28,
                  "year": 2025
              }

              ref = db.reference('subtitled_movies')
              for vid in ids_to_update:
                  data_copy = video_data.copy()
                  data_copy["id"] = int(vid)
                  ref.child(vid).set(data_copy)
                  print(f"âœ… ID {vid} Ù¾Û†Ø³Øª Ú©Ø±Ø§")

          except Exception as e:
              print(f"âŒ Ù‡Û•ÚµÛ• Ú•ÙˆÙˆÛŒØ¯Ø§: {e}")
              exit(1)
