name: Video_Auto_ID_To_Firebase
on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Direct Link (Seedr)'
        required: true

jobs:
  convert_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ—ï¸ Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 ffmpeg python3-pip
          pip3 install firebase-admin

      - name: â¬‡ï¸ Download
        run: |
          aria2c --max-connection-per-server=16 --split=16 -o "source_video" "${{ github.event.inputs.video_url }}"

      - name: ğŸ¬ Process
        run: |
          ffmpeg -i "source_video" -c copy -movflags +faststart -y "final_video.mp4"

      - name: ğŸš€ Upload Release
        id: upload_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ github.run_number }}"
          files: final_video.mp4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Auto Push to Firebase
        shell: python
        env:
          FB_KEY: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          DATABASE_URL: "https://sarko-43d61-default-rtdb.firebaseio.com/"
        run: |
          import firebase_admin
          from firebase_admin import credentials, db
          import json
          import os

          try:
              key_dict = json.loads(os.environ['FB_KEY'])
              cred = credentials.Certificate(key_dict)
              firebase_admin.initialize_app(cred, {'databaseURL': os.environ['DATABASE_URL']})
              
              ref = db.reference('subtitled_movies')
              
              # Ù¡. Ø¯Û†Ø²ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¯ÙˆØ§ÛŒÙ† Ø¦Ø§ÛŒØ¯ÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡Ø§ØªÙˆÙˆ
              all_movies = ref.get()
              
              if all_movies:
                  # ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø¦Ø§ÛŒØ¯ÛŒÛŒÛ•Ú©Ø§Ù† Ùˆ Ú¯Û†Ú•ÛŒÙ†ÛŒØ§Ù† Ø¨Û† Ú˜Ù…Ø§Ø±Û• Ø¨Û† Ø¯Û†Ø²ÛŒÙ†Û•ÙˆÛ•ÛŒ Ú¯Û•ÙˆØ±Û•ØªØ±ÛŒÙ†ÛŒØ§Ù†
                  existing_ids = [int(k) for k in all_movies.keys() if k.isdigit()]
                  next_id = max(existing_ids) + 1
              else:
                  next_id = 20035 # Ø¦Û•Ú¯Û•Ø± Ø¯Ø§ØªØ§Ø¨Û•ÛŒØ³Û•Ú©Û• Ø¨Û•ØªØ§Úµ Ø¨ÙˆÙˆ Ù„Û•Ù…Û•ÙˆÛ• Ø¯Û•Ø³Øª Ù¾Û Ø¨Ú©Ø§Øª

              # Ù¢. Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ø¯Ø§ØªØ§ÛŒ ÙÛŒÙ„Ù…Û•Ú©Û•
              github_repo = os.environ['GITHUB_REPOSITORY']
              run_number = os.environ['GITHUB_RUN_NUMBER']
              
              video_data = {
                  "badge_text": "FREE",
                  "description": "Ú†ÛŒØ±Û†Ú©ÛŒ ÙÛŒÙ„Ù…Û•Ú©Û• Ø¨Ø§Ø³ Ù„Û• Ú©Ú†ÛÚ©ÛŒ Ú¯Û•Ù†Ø¬ Ø¯Û•Ú©Ø§Øª Ú©Û• Ù„Û• Ú•ÛÚ¯Û•ÛŒ Ø¦Û•Ù¾ÛÚ©ÛŒ Ú˜ÙˆØ§Ù†Ø¨Û•Ø³ØªÙ†Û•ÙˆÛ• Ú©ÙˆÚ•ÛÚ© Ø¯Û•Ù†Ø§Ø³ÛØª Ú©Û• Ø²Û†Ø± Ø³Û•Ø±Ù†Ø¬Ú•Ø§Ú©ÛØ´ Ùˆ Ø¨Û•Ú•Û•ÙˆØ´Øª Ø¯Û•Ø±Ø¯Û•Ú©Û•ÙˆÛØª...",
                  "genre_id": 6,
                  "id": next_id,
                  "image": "https://raw.githubusercontent.com/Skugiijb546vi/ok/refs/heads/main/good-boy-2025.jpg",
                  "imdb": 8.5,
                  "subtitleArabic": "https://raw.githubusercontent.com/Skugiijb546vi/Boolo_ass/refs/heads/main/Good.Boy.2025.1080p.AMZN.WEB-DL.DDP5.1.H.264-English.srt",
                  "subtitleEnglish": "https://raw.githubusercontent.com/Skugiijb546vi/Boolo_ass/refs/heads/main/Good.Boy.2025.1080p.AMZN.WEB-DL.DDP5.1.H.264-English.srt",
                  "subtitleKurdish": "https://raw.githubusercontent.com/Skugiijb546vi/kurdil/refs/heads/main/oi.srt",
                  "title": f"good boy - ID {next_id}",
                  "translation": "Ú˜ÛØ±Ù†ÙˆÙˆØ³",
                  "url": f"https://github.com/{github_repo}/releases/download/v{run_number}/final_video.mp4",
                  "views": 28,
                  "year": 2025
              }

              # Ù£. Ù¾Û†Ø³ØªÚ©Ø±Ø¯Ù† Ø¨Û† ÙØ§ÛŒÛ•Ø±Ø¨Û•ÛŒØ³
              ref.child(str(next_id)).set(video_data)
              print(f"âœ… Ù¾Û†Ø³Øª Ú©Ø±Ø§ Ø¨Û† Ø¦Ø§ÛŒØ¯ÛŒ Ù†ÙˆÛ: {next_id}")

          except Exception as e:
              print(f"âŒ Ù‡Û•ÚµÛ•: {e}")
              exit(1)
